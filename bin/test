#!/bin/bash

# Wallhaven API URL (modify as needed for different categories)
API_URL="https://wallhaven.cc/api/v1/search?sorting=random"

# Temporary directory for storing previews
TMP_DIR="/tmp/wallhaven_preview"
mkdir -p "$TMP_DIR"

# Fetch wallpaper data
echo "Fetching wallpapers..."
RESPONSE=$(curl -s "$API_URL")

# Extract wallpaper preview URLs and full image URLs
PREVIEW_URLS=($(echo "$RESPONSE" | jq -r '.data[].thumbs.original'))
IMAGE_URLS=($(echo "$RESPONSE" | jq -r '.data[].path'))

# Download previews
echo "Downloading previews..."
for i in "${!PREVIEW_URLS[@]}"; do
    curl -s -o "$TMP_DIR/$i.jpg" "${PREVIEW_URLS[$i]}" &
done
wait

# Use fzf to preview and select a wallpaper
SELECTED_INDEX=$(ls "$TMP_DIR" | fzf --preview 'kitty icat --clear --transfer-mode=memory --stdin=no --place="${FZF_PREVIEW_COLUMNS}x${FZF_PREVIEW_LINES}@0x0" "$TMP_DIR/$(basename {})"')

if [ -n "$SELECTED_INDEX" ]; then
    # Get the full image URL
    WALLPAPER_URL="${IMAGE_URLS[$SELECTED_INDEX]}"

    # Download and set the wallpaper
    echo "Downloading wallpaper..."
    wget -q "$WALLPAPER_URL" -O "$HOME/Pictures/wallhaven_selected.jpg"

    # Set the wallpaper (modify for your system)
    feh --bg-scale "$HOME/Pictures/wallhaven_selected.jpg"

    echo "Wallpaper set successfully!"
else
    echo "No wallpaper selected."
fi

# Cleanup
rm -rf "$TMP_DIR"
